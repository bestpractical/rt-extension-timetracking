From 30935bb85e63a168b31559d7d2e225134a694a15 Mon Sep 17 00:00:00 2001
From: sunnavy <sunnavy@bestpractical.com>
Date: Tue, 12 Nov 2013 21:49:46 +0800
Subject: [PATCH] handle txn cfs on ticket creation and updates(with
 UpdateTimeWorked but no content)

---
 lib/RT/Interface/Web.pm | 16 ++++++++++++++--
 lib/RT/Ticket.pm        |  2 +-
 2 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/lib/RT/Interface/Web.pm b/lib/RT/Interface/Web.pm
index 2dd0fd1..4a73d3b 100644
--- a/lib/RT/Interface/Web.pm
+++ b/lib/RT/Interface/Web.pm
@@ -2760,7 +2760,6 @@ sub ProcessTicketBasics {
         FinalPriority
         Priority
         TimeEstimated
-        TimeWorked
         TimeLeft
         Type
         Status
@@ -2789,6 +2788,12 @@ sub ProcessTicketBasics {
         ARGSRef       => $ARGSRef,
     );
 
+    if ( defined $ARGSRef->{'TimeWorked'} ) {
+        my ( $val, $msg, $txn ) = $TicketObj->SetTimeWorked( $ARGSRef->{'TimeWorked'} );
+        push( @results, $msg );
+        $txn->UpdateCustomFields( %$ARGSRef) if $txn;
+    }
+
     # We special case owner changing, so we can use ForceOwnerChange
     if ( $ARGSRef->{'Owner'}
       && $ARGSRef->{'Owner'} !~ /\D/
@@ -3169,7 +3174,14 @@ sub ProcessObjectCustomFieldUpdatesForCreate {
                 );
             }
 
-            $parsed{"CustomField-$cfid"} = \@values if @values;
+            if (@values) {
+                if ( $class eq 'RT::Transaction' ) {
+                    $parsed{"Object-RT::Transaction--CustomField-$cfid"} = \@values;
+                }
+                else {
+                    $parsed{"CustomField-$cfid"} = \@values if @values;
+                }
+            }
         }
     }
 
diff --git a/lib/RT/Ticket.pm b/lib/RT/Ticket.pm
index 80af7f5..d4e2055 100644
--- a/lib/RT/Ticket.pm
+++ b/lib/RT/Ticket.pm
@@ -2671,7 +2671,7 @@ sub _Set {
     # just made the ticket unreadable to us
     $trans->{ _object_is_readable } = 1;
 
-    return ( $ret, scalar $trans->BriefDescription );
+    return ( $ret, scalar $trans->BriefDescription, $trans );
 }
 
 
-- 
1.8.4.1

